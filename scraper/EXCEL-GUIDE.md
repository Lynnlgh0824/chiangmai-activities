# 📊 爬虫数据自动写入 Excel 表格指南

## 🎯 功能说明

爬虫现在可以**自动将抓取的小红书活动数据写入到您的【清迈活动数据.xlsx】**中！

### ✨ 核心特性

1. **智能分类** - 自动判断是"固定频率活动"还是"临时活动"
2. **字段映射** - 自动提取并映射到表格的18个字段
3. **直接写入** - 直接追加到现有表格，保留原有数据
4. **自动备份** - 每次写入前自动备份原文件

---

## 📋 数据字段映射

### 爬取数据 → Excel 字段

| 爬取字段 | Excel 字段 | 说明 |
|---------|-----------|------|
| title | 活动标题 | 自动提取标题 |
| description | 活动描述 | 活动详细描述 |
| category | 分类 | 瑜伽/冥想/美食等 |
| price | 价格显示/最低价格/最高价格 | 自动解析数字 |
| time + weekdays | 星期 | 固定频率活动 |
| time + date | 具体日期 | 临时活动 |
| time | 时间 | 自动格式化为 HH:MM-HH:MM |
| location | 地点名称 | 清迈各地区 |
| description | 持续时间 | 自动计算或提取 |
| images | 图片URL | 多个URL换行分隔 |
| url | 来源链接 | 原始帖子链接 |

---

## 🚀 使用步骤

### 步骤 1: 准备 Excel 文件

确保【清迈活动数据.xlsx】在项目根目录：

```
Chiengmai/
├── 清迈活动数据.xlsx  ← 确保这个文件在这里
├── scraper/
│   ├── xiaohongshu-scraper.js
│   └── excel-writer.js
└── ...
```

### 步骤 2: 运行爬虫

```bash
cd scraper
./run.sh
```

或

```bash
npm start
```

### 步骤 3: 扫码登录

- 浏览器打开小红书
- 30秒内扫码登录
- 等待自动抓取

### 步骤 4: 自动写入

抓取完成后，爬虫会：

1. ✅ **数据预览** - 显示前3条抓取的数据
2. ✅ **智能分类** - 自动判断活动类型
3. ✅ **写入表格** - 追加到对应工作表
4. ✅ **备份文件** - 创建备份文件

输出示例：

```
📋 数据预览 (前3条):

1. 清迈瑜伽早课
   类型: 固定频率活动
   分类: 瑜伽 | 价格: 500฿
   地点: 宁曼路
   时间: 周一,周三,周五 09:00-11:00

2. 泰式烹饪工作坊
   类型: 临时活动
   分类: 美食体验 | 价格: 500฿
   地点: 清迈烹饪学校
   时间: 2025-02-01 14:00-17:00

📥 正在写入 Excel 表格...
✅ Excel 写入成功！
   - 总计: 15 条
   - 固定频率活动: 8 条
   - 临时活动: 7 条
📦 备份文件: 活动录入表格-backup.xlsx
```

---

## 📊 智能分类规则

### 固定频率活动（绿色工作表）

**判断条件：**
- ✅ 包含"每天"、"每周"、"定期"
- ✅ 包含"周一"、"周二"等星期
- ✅ 包含"Mon"、"Tue"等英文星期
- ✅ 描述中提到重复进行

**写入字段：**
- 星期：周一,周三,周五
- 时间：09:00-11:00

**示例：**
```
标题: 清迈流瑜伽早课
描述: 每周一三五上午9点进行
→ 归类为: 固定频率活动
→ 星期: 周一,周三,周五
→ 时间: 09:00-11:00
```

### 临时活动（黄色工作表）

**判断条件：**
- ❌ 没有星期关键词
- ❌ 没有重复描述
- ✅ 包含具体日期

**写入字段：**
- 具体日期：2025-02-01
- 时间：14:00-17:00

**示例：**
```
标题: 泰式烹饪工作坊
描述: 学习制作泰式料理，包含冬阴功汤
→ 归类为: 临时活动
→ 具体日期: 2025-02-01（默认今天）
→ 时间: 14:00-17:00
```

---

## 🔍 字段提取逻辑

### 价格信息

**自动识别：**
- `500฿` → 价格显示: "500฿", 最低价格: 500, 最高价格: 500
- `免费` → 价格显示: "免费", 最低价格: 0, 最高价格: 0
- `500-1000฿` → 价格显示: "500-1000฿", 最低价格: 500, 最高价格: 1000

**支持格式：**
- `500฿`、`500 泰铢`、`500 THB`、`500 บาท`

### 时间信息

**自动提取：**
- `每天 9:00-11:00` → 时间: "09:00-11:00"
- `14:00-17:00` → 时间: "14:00-17:00"

**自动计算持续时长：**
- `09:00-11:00` → 持续时间: "2.0小时"
- `14:00-17:30` → 持续时间: "3.5小时"

### 日期信息

**固定频率活动：**
- `每周一三五` → 星期: "周一,周三,周五"
- `周一和周三` → 星期: "周一,周三"

**临时活动：**
- `2025年2月1日` → 具体日期: "2025-02-01"
- `2/1` → 具体日期: "2025-02-01"
- 未找到日期 → 使用今天日期

### 地点信息

**自动识别：**
- `清迈宁曼路` → 地点名称: "清迈宁曼路"
- `宁曼瑜伽馆` → 地点名称: "宁曼瑜伽馆"
- 未找到 → 默认: "清迈"

### 分类信息

**自动分类：**
- 包含"瑜伽"、"Yoga" → 分类: "瑜伽"
- 包含"冥想"、"meditation" → 分类: "冥想"
- 包含"烹饪"、"美食"、"泰餐" → 分类: "美食体验"
- 包含"泰拳"、"拳击" → 分类: "户外探险"
- 其他 → 分类: "其他"

---

## 📁 文件管理

### 输出文件

爬虫运行后会生成以下文件：

```
Chiengmai/
├── 清迈活动数据.xlsx              # 主文件（已更新）
├── 活动录入表格-backup.xlsx       # 自动备份
├── 活动录入表格-改进版-backup.xlsx # 如果是改进版
└── data/scrapped/
    ├── xiaohongshu-chiangmai-activities-时间戳.json  # JSON备份
    └── xiaohongshu-chiangmai-activities-时间戳.csv   # CSV备份
```

### 备份策略

每次写入前会：
1. 自动备份原文件
2. 添加 `-backup` 后缀
3. 保留历史数据

**建议：**
- 定期清理旧备份文件
- 重要数据单独备份到云盘

---

## ⚙️ 高级配置

### 修改分类规则

编辑 `scraper/excel-writer.js`：

```javascript
// 自动分类规则
if (content.includes('瑜伽') || content.includes('Yoga')) {
  return '瑜伽';
} else if (content.includes('冥想')) {
  return '冥想';
}
// 添加更多规则...
```

### 修改活动类型判断

编辑 `determineActivityType` 函数：

```javascript
function determineActivityType(activity) {
  const regularKeywords = [
    '每天', '每周',
    '自定义关键词',  // 添加新关键词
  ];

  // 自定义逻辑...
}
```

### 调整默认值

修改默认地点、持续时间等：

```javascript
const row = {
  '地点名称': activity.location || '清迈',  // 默认地点
  '持续时间': timeInfo.duration || '2小时',  // 默认时长
  '状态': '草稿',  // 默认状态
};
```

---

## 🐛 故障排查

### 问题 1: 无法写入 Excel

**原因：**
- Excel 文件正在被其他程序打开
- 文件路径不正确
- 权限问题

**解决：**
```bash
# 检查文件是否存在
ls -lh ../清迈活动数据.xlsx

# 确保文件已关闭
# macOS: 检查是否有 Excel 程序在运行

# 检查权限
ls -l ../清迈活动数据.xlsx
```

### 问题 2: 写入后打开乱码

**原因：**
- Excel 编码问题

**解决：**
- 使用 Numbers（macOS）打开
- 或导入 CSV 文件

### 问题 3: 数据写入位置不对

**原因：**
- 工作表结构变化

**解决：**
- 检查 Excel 文件结构是否与模板一致
- 确认有三个工作表：活动汇总、固定频率活动、临时活动

### 问题 4: 分类不准确

**解决：**
- 手动调整 Excel 中的分类
- 或修改 `excel-writer.js` 中的分类规则

---

## 💡 使用技巧

### 1. 分批导入

如果数据量很大，可以分批抓取：

```bash
# 第一批：搜索"清迈瑜伽"
# 修改 config.js 中的 keywords
npm start

# 手动检查 Excel

# 第二批：搜索"清迈冥想"
# 再次修改 config.js
npm start
```

### 2. 手动验证

每次抓取后：
1. 打开 Excel 文件
2. 查看新增的数据
3. 检查分类是否正确
4. 调整不准确的字段

### 3. 数据清洗

在 Excel 中：
1. 筛选"分类"列
2. 批量修改不准确的分类
3. 补充缺失的必填字段
4. 删除重复数据

### 4. 导入到后台

数据验证后：
1. 打开 `http://localhost:3000/admin.html`
2. 根据类型选择对应 Tab
3. 参照 Excel 数据录入

---

## 📊 数据流程图

```
小红书网站
    ↓
Puppeteer 爬虫
    ↓
提取活动信息 (JSON)
    ↓
智能分类 (固定频率 vs 临时活动)
    ↓
字段映射 (18个字段)
    ↓
写入 Excel 表格
    ├── 固定频率活动（绿色工作表）
    └── 临时活动（黄色工作表）
    ↓
备份数据 (JSON + CSV)
    ↓
手动验证调整
    ↓
导入到后台系统
```

---

## ✅ 完整工作流

### 日常使用流程

```bash
# 1. 进入爬虫目录
cd scraper

# 2. （可选）修改搜索关键词
# 编辑 config.js

# 3. 运行爬虫
./run.sh

# 4. 扫码登录
# 等待自动完成

# 5. 查看结果
# 打开 清迈活动数据.xlsx

# 6. 验证数据
# 检查分类、价格、时间等

# 7. 导入后台
# http://localhost:3000/admin.html
```

---

## 🎯 示例：完整抓取过程

```bash
$ cd scraper
$ ./run.sh

🚀 小红书清迈活动爬虫启动
==================================================

🌐 正在启动浏览器...
✅ 浏览器启动成功

⏰ 给您 30 秒时间登录...
[浏览器窗口打开，扫码登录]

🔍 正在搜索: 清迈瑜伽
  📜 滚动加载第 1 次...
  📜 滚动加载第 2 次...
  ✅ 找到 15 个相关帖子
  📖 正在读取: 清迈流瑜伽早课
    ✅ 已提取: 清迈流瑜伽早课
  📖 正在读取: 宁曼路瑜伽课
    ✅ 已提取: 宁曼路瑜伽课
  ...

📋 数据预览 (前3条):

1. 清迈流瑜伽早课
   类型: 固定频率活动
   分类: 瑜伽 | 价格: 500฿
   地点: 宁曼路
   时间: 周一,周三,周五 09:00-11:00

📥 正在写入 Excel 表格...
✅ Excel 写入成功！
   - 总计: 15 条
   - 固定频率活动: 8 条
   - 临时活动: 7 条
📦 备份文件: 活动录入表格-backup.xlsx

✅ 所有任务完成！
```

---

## 📞 需要帮助？

- **查看完整文档**: `README.md`
- **快速指南**: `QUICKSTART.md`
- **问题排查**: 检查日志输出

---

**最后更新**: 2025-01-25
**版本**: 2.0 (Excel集成版)
