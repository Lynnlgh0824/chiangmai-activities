name: æ•°æ®è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [ main, dev ]
    paths:
      - 'data/items.json'
      - 'scripts/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'data/items.json'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  quality-check:
    name: æ•°æ®è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: |
          if [ -f package.json ]; then
            npm ci
          fi

      - name: è¿è¡Œæ•°æ®è´¨é‡æµ‹è¯•
        run: |
          node scripts/test-cases.mjs
        continue-on-error: true

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-report
          path: data/test-report.json
          retention-days: 30

      - name: æ£€æŸ¥æµ‹è¯•ç»“æœ
        run: |
          if [ -f data/test-report.json ]; then
            node -e "
              const report = JSON.parse(require('fs').readFileSync('data/test-report.json', 'utf8'));
              console.log('æ€»æµ‹è¯•æ•°:', report.summary.totalTests);
              console.log('é€šè¿‡:', report.summary.totalPassed);
              console.log('å¤±è´¥:', report.summary.totalFailed);
              console.log('è­¦å‘Š:', report.summary.totalWarnings);

              if (report.summary.totalFailed > 0) {
                console.error('æµ‹è¯•å¤±è´¥ï¼');
                process.exit(1);
              }
            "
          fi

  format-check:
    name: æ ¼å¼æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: æ£€æŸ¥ JSON æ ¼å¼
        run: |
          echo "æ£€æŸ¥ items.json æ ¼å¼..."
          node -e "
            const fs = require('fs');
            try {
              const data = JSON.parse(fs.readFileSync('data/items.json', 'utf8'));
              console.log('âœ… JSON æ ¼å¼æ­£ç¡®');
              console.log('   æ´»åŠ¨æ•°é‡:', data.length);
            } catch (error) {
              console.error('âŒ JSON æ ¼å¼é”™è¯¯:', error.message);
              process.exit(1);
            }
          "

      - name: æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
        run: |
          echo "æ£€æŸ¥æ•°æ®å®Œæ•´æ€§..."
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('data/items.json', 'utf8'));

            let errors = 0;

            data.forEach((item, index) => {
              if (!item.id) {
                console.error(\`âŒ æ´»åŠ¨ \${index + 1} ç¼ºå°‘ ID\`);
                errors++;
              }
              if (!item.title) {
                console.error(\`âŒ æ´»åŠ¨ \${index + 1} ç¼ºå°‘æ ‡é¢˜\`);
                errors++;
              }
              if (!item.description) {
                console.error(\`âŒ æ´»åŠ¨ \${index + 1} ç¼ºå°‘æè¿°\`);
                errors++;
              }
            });

            if (errors > 0) {
              console.error(\`âŒ å‘ç° \${errors} ä¸ªé”™è¯¯\`);
              process.exit(1);
            } else {
              console.log('âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡');
            }
          "

      - name: æ£€æŸ¥é‡å¤ ID
        run: |
          echo "æ£€æŸ¥é‡å¤ ID..."
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('data/items.json', 'utf8'));

            const ids = new Set();
            const duplicates = new Set();

            data.forEach(item => {
              if (ids.has(item.id)) {
                duplicates.add(item.id);
              }
              ids.add(item.id);
            });

            if (duplicates.size > 0) {
              console.error(\`âŒ å‘ç°é‡å¤ ID: \${[...duplicates].join(', ')}\`);
              process.exit(1);
            } else {
              console.log('âœ… æ— é‡å¤ ID');
            }
          "

  description-quality:
    name: æè¿°è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: æ£€æŸ¥æè¿°é‡å¤
        run: |
          echo "æ£€æŸ¥æè¿°é‡å¤..."
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('data/items.json', 'utf8'));

            let issues = 0;

            data.forEach(item => {
              const desc = item.description || '';

              // æ£€æŸ¥åŒæ„Ÿå¹å·
              if (desc.includes('!!')) {
                console.warn(\`âš ï¸  æ´»åŠ¨ \${item.id} åŒ…å«åŒæ„Ÿå¹å·\`);
                issues++;
              }

              // æ£€æŸ¥å¤šé‡æ„Ÿå¹å·emoji
              if (desc.includes('â€¼ï¸') || desc.includes('â—â—')) {
                console.warn(\`âš ï¸  æ´»åŠ¨ \${item.id} åŒ…å«å¤šé‡æ„Ÿå¹å·emoji\`);
                issues++;
              }

              // æ£€æŸ¥é‡å¤è­¦å‘Šç¬¦å·
              if (/(âš ï¸\\s*){2,}/.test(desc)) {
                console.warn(\`âš ï¸  æ´»åŠ¨ \${item.id} åŒ…å«é‡å¤âš ï¸ç¬¦å·\`);
                issues++;
              }

              // æ£€æŸ¥ç‘œä¼½å«é‡å¤
              if (desc.includes('éœ€è¦è‡ªå·±å¸¦ç‘œä¼½å«') && desc.includes('éœ€è‡ªå¤‡ç‘œä¼½å«')) {
                console.warn(\`âš ï¸  æ´»åŠ¨ \${item.id} å­˜åœ¨ç‘œä¼½å«è¯­ä¹‰é‡å¤\`);
                issues++;
              }

              // æ£€æŸ¥ä»·æ ¼æ ¼å¼é‡å¤
              const hasPrice1 = /\\d+æ³°é“¢\\/å•æ¬¡è¯¾ç¨‹/.test(desc);
              const hasPrice2 = /å•æ¬¡è¯¾ç¨‹\\d+æ³°é“¢/.test(desc);
              if (hasPrice1 && hasPrice2) {
                console.warn(\`âš ï¸  æ´»åŠ¨ \${item.id} å­˜åœ¨ä»·æ ¼æ ¼å¼é‡å¤\`);
                issues++;
              }
            });

            console.log(\`å‘ç°é—®é¢˜: \${issues} ä¸ª\`);

            if (issues > 10) {
              console.error('âŒ é—®é¢˜è¿‡å¤šï¼Œå»ºè®®è¿è¡Œä¿®å¤è„šæœ¬');
              process.exit(1);
            }
          "
        continue-on-error: true

      - name: ç”Ÿæˆè´¨é‡æŠ¥å‘Š
        if: always()
        run: |
          echo "ç”Ÿæˆè´¨é‡æŠ¥å‘Š..."
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('data/items.json', 'utf8'));

            const stats = {
              totalActivities: data.length,
              withDescription: data.filter(i => i.description).length,
              avgDescriptionLength: Math.round(
                data.reduce((sum, i) => sum + (i.description || '').length, 0) / data.length
              ),
              hasNotice: data.filter(i => (i.description || '').includes('âš ï¸')).length,
              hasPrice: data.filter(i => (i.description || '').includes('æ³°é“¢')).length,
              emptyDescriptions: data.filter(i => !i.description || i.description.trim().length === 0).length
            };

            console.log('\\nğŸ“Š æè¿°è´¨é‡ç»Ÿè®¡:');
            console.log('   æ€»æ´»åŠ¨æ•°:', stats.totalActivities);
            console.log('   æœ‰æè¿°:', stats.withDescription);
            console.log('   å¹³å‡æè¿°é•¿åº¦:', stats.avgDescriptionLength, 'å­—ç¬¦');
            console.log('   åŒ…å«æ³¨æ„äº‹é¡¹:', stats.hasNotice);
            console.log('   åŒ…å«ä»·æ ¼ä¿¡æ¯:', stats.hasPrice);
            console.log('   ç©ºæè¿°:', stats.emptyDescriptions);
            console.log('');

            fs.writeFileSync(
              'data/quality-stats.json',
              JSON.stringify(stats, null, 2),
              'utf8'
            );
          "

      - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: quality-stats
          path: data/quality-stats.json
          retention-days: 30
