import { useState, useEffect, useMemo } from 'react'
import axios from 'axios'
import { getCategories } from './data/activities'
import './App.css'

// API åŸºç¡€åœ°å€
const API_BASE = import.meta.env.VITE_API_URL || 'http://localhost:3000'

// API å®¢æˆ·ç«¯
const api = axios.create({
  baseURL: `${API_BASE}/api`,
  timeout: 10000
})

function App() {
  const [activities, setActivities] = useState([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [selectedCategory, setSelectedCategory] = useState('å…¨éƒ¨')
  const [priceFilter, setPriceFilter] = useState('å…¨éƒ¨')
  const [viewMode, setViewMode] = useState('calendar') // 'calendar' or 'list'
  const [currentWeekStart, setCurrentWeekStart] = useState(() => {
    // åˆå§‹åŒ–åˆ°æœ¬å‘¨çš„å‘¨ä¸€
    const today = new Date()
    const day = today.getDay()
    const diff = today.getDate() - day + (day === 0 ? -6 : 1)
    const monday = new Date(today.setDate(diff))
    monday.setHours(0, 0, 0, 0)
    return monday
  })

  const categories = getCategories()
  const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­']

  // è·å–æ´»åŠ¨æ•°æ®
  useEffect(() => {
    fetchActivities()
  }, [])

  const fetchActivities = async () => {
    try {
      const response = await api.get('/activities', {
        params: {
          status: 'active',
          limit: 1000
        }
      })
      setActivities(response.data.data)
      setLoading(false)
    } catch (error) {
      console.error('è·å–æ´»åŠ¨æ•°æ®å¤±è´¥:', error)
      setActivities([])
      setLoading(false)
    }
  }

  // ç­›é€‰æ´»åŠ¨
  const filteredActivities = useMemo(() => {
    let result = activities

    // æœç´¢ç­›é€‰
    if (searchTerm) {
      result = result.filter(activity =>
        activity.title?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        activity.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        activity.location?.toLowerCase().includes(searchTerm.toLowerCase())
      )
    }

    // åˆ†ç±»ç­›é€‰
    if (selectedCategory !== 'å…¨éƒ¨') {
      result = result.filter(activity => activity.category === selectedCategory)
    }

    // ä»·æ ¼ç­›é€‰
    if (priceFilter === 'å…è´¹') {
      result = result.filter(activity =>
        activity.price === 'å…è´¹' || activity.price.includes('å…è´¹')
      )
    } else if (priceFilter === '1500à¸¿â†“') {
      result = result.filter(activity => {
        const price = parseInt(activity.price.replace(/[^\d]/g, '')) || 0
        return !activity.price.includes('å…è´¹') && price < 1500
      })
    } else if (priceFilter === '1500à¸¿â†‘') {
      result = result.filter(activity => {
        const price = parseInt(activity.price.replace(/[^\d]/g, '')) || 0
        return price >= 1500
      })
    }

    return result
  }, [activities, searchTerm, selectedCategory, priceFilter])

  // è·å–æœ¬å‘¨çš„æ´»åŠ¨
  const getWeekActivities = () => {
    const weekEnd = new Date(currentWeekStart)
    weekEnd.setDate(weekEnd.getDate() + 6)

    const weekActivities = {}

    // åˆå§‹åŒ–7å¤©
    for (let i = 0; i < 7; i++) {
      const date = new Date(currentWeekStart)
      date.setDate(date.getDate() + i)
      const dateStr = date.toISOString().split('T')[0]
      weekActivities[dateStr] = []
    }

    // åˆ†é…æ´»åŠ¨åˆ°å¯¹åº”æ—¥æœŸ
    filteredActivities.forEach(activity => {
      if (activity.date) {
        const activityDate = new Date(activity.date)
        const dateStr = activityDate.toISOString().split('T')[0]
        if (weekActivities[dateStr]) {
          weekActivities[dateStr].push(activity)
        }
      }
    })

    return weekActivities
  }

  // å‘¨å¯¼èˆª
  const goToPrevWeek = () => {
    const newDate = new Date(currentWeekStart)
    newDate.setDate(newDate.getDate() - 7)
    setCurrentWeekStart(newDate)
  }

  const goToNextWeek = () => {
    const newDate = new Date(currentWeekStart)
    newDate.setDate(newDate.getDate() + 7)
    setCurrentWeekStart(newDate)
  }

  const goToThisWeek = () => {
    const today = new Date()
    const day = today.getDay()
    const diff = today.getDate() - day + (day === 0 ? -6 : 1)
    const monday = new Date(today.setDate(diff))
    monday.setHours(0, 0, 0, 0)
    setCurrentWeekStart(monday)
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  const formatDate = (dateStr) => {
    const date = new Date(dateStr)
    const today = new Date()
    today.setHours(0, 0, 0, 0)
    const targetDate = new Date(dateStr)
    targetDate.setHours(0, 0, 0, 0)

    const diffTime = targetDate - today
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))

    if (diffDays === 0) {
      return 'ä»Šå¤©'
    } else if (diffDays === 1) {
      return 'æ˜å¤©'
    }
    return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`
  }

  // è·å–åˆ†ç±»é¢œè‰²
  const getCategoryColor = (category) => {
    const colors = {
      'ç‘œä¼½': '#FF6B6B',
      'å†¥æƒ³': '#4ECDC4',
      'æˆ·å¤–æ¢é™©': '#FFE66D',
      'æ–‡åŒ–è‰ºæœ¯': '#95E1D3',
      'ç¾é£Ÿä½“éªŒ': '#F38181',
      'èŠ‚åº†æ´»åŠ¨': '#AA96DA',
      'å…¶ä»–': '#667eea'
    }
    return colors[category] || '#667eea'
  }

  const weekActivities = getWeekActivities()
  const weekDates = []
  for (let i = 0; i < 7; i++) {
    const date = new Date(currentWeekStart)
    date.setDate(date.getDate() + i)
    weekDates.push(date.toISOString().split('T')[0])
  }

  const today = new Date()
  today.setHours(0, 0, 0, 0)

  if (loading) {
    return (
      <div className="app">
        <div className="loading-container">
          <div className="loading-spinner"></div>
          <p>åŠ è½½ä¸­...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="app">
      {/* å¤´éƒ¨å¯¼èˆªæ  */}
      <header className="main-header">
        <div className="header-content-wrapper">
          <div className="header-left">
            <h1 className="site-title">âœ¨ æ¸…è¿ˆæ´»åŠ¨æ¢ç´¢</h1>
          </div>
          <div className="header-right">
            <div className="search-container">
              <input
                type="text"
                className="search-input"
                placeholder="æœç´¢æ´»åŠ¨ã€åœ°ç‚¹ã€å…³é”®è¯..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
              />
              <button className="search-button">æœç´¢</button>
            </div>
          </div>
        </div>
      </header>

      {/* åˆ†ç±»ç­›é€‰åŒº */}
      <div className="filter-section">
        <div className="filter-row">
          <div className="filter-group">
            <span className="filter-label">åˆ†ç±»:</span>
            <div className="filter-buttons">
              {categories.map(cat => (
                <button
                  key={cat}
                  className={`filter-btn ${selectedCategory === cat ? 'active' : ''}`}
                  onClick={() => setSelectedCategory(cat)}
                >
                  {cat}
                </button>
              ))}
            </div>
          </div>

          <div className="filter-group">
            <span className="filter-label">ä»·æ ¼:</span>
            <div className="filter-buttons">
              {['å…¨éƒ¨', 'å…è´¹', '1500à¸¿â†“', '1500à¸¿â†‘'].map(price => (
                <button
                  key={price}
                  className={`filter-btn ${priceFilter === price ? 'active' : ''}`}
                  onClick={() => setPriceFilter(price)}
                >
                  {price}
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* è§†å›¾åˆ‡æ¢åŒº */}
      <div className="view-toggle-section">
        <div className="view-tabs">
          <button
            className={`view-tab ${viewMode === 'calendar' ? 'active' : ''}`}
            onClick={() => setViewMode('calendar')}
          >
            <span className="tab-icon">ğŸ“…</span>
            æ—¥å†è§†å›¾
          </button>
          <button
            className={`view-tab ${viewMode === 'list' ? 'active' : ''}`}
            onClick={() => setViewMode('list')}
          >
            <span className="tab-icon">ğŸ“‹</span>
            åˆ—è¡¨è§†å›¾
          </button>
        </div>
      </div>

      {/* æ—¥æœŸå¯¼èˆªåŒº */}
      {viewMode === 'calendar' && (
        <div className="date-navigation">
          <div className="month-label">
            {currentWeekStart.getFullYear()}å¹´{currentWeekStart.getMonth() + 1}æœˆ
          </div>
          <div className="nav-buttons">
            <button className="nav-btn" onClick={goToPrevWeek}>
              â† ä¸Šä¸€å‘¨
            </button>
            <button className="nav-btn" onClick={goToThisWeek}>
              å›åˆ°æœ¬å‘¨
            </button>
            <button className="nav-btn" onClick={goToNextWeek}>
              ä¸‹ä¸€å‘¨ â†’
            </button>
          </div>
        </div>
      )}

      {/* ä¸»å†…å®¹åŒº */}
      <div className="main-content">
        {viewMode === 'calendar' ? (
          /* å‘¨æ—¥å†è§†å›¾ */
          <div className="calendar-view">
            <div className="week-grid">
              {weekDates.map((dateStr, idx) => {
                const date = new Date(dateStr)
                const isToday = date.toDateString() === today.toDateString()
                const dayActivities = weekActivities[dateStr] || []
                const dayName = dayNames[date.getDay()]

                return (
                  <div key={dateStr} className="day-column">
                    <div className={`day-header ${isToday ? 'today' : ''}`}>
                      <div className="day-date">{date.getDate()}</div>
                      <div className="day-name">{dayName}</div>
                      {isToday && <div className="today-badge">ä»Šå¤©</div>}
                    </div>
                    <div className="day-activities">
                      {dayActivities.map(activity => (
                        <div
                          key={activity.id || activity._id}
                          className="activity-card-mini"
                          style={{ borderLeftColor: getCategoryColor(activity.category) }}
                        >
                          <div className="activity-time">{activity.time}</div>
                          <div className="activity-title">{activity.title}</div>
                          <div className="activity-location">ğŸ“ {activity.location}</div>
                          <div className="activity-price">{activity.price}</div>
                        </div>
                      ))}
                      {dayActivities.length === 0 && (
                        <div className="no-activities">æš‚æ— æ´»åŠ¨</div>
                      )}
                    </div>
                  </div>
                )
              })}
            </div>
          </div>
        ) : (
          /* åˆ—è¡¨è§†å›¾ */
          <div className="list-view">
            <div className="activities-list">
              {filteredActivities.map(activity => (
                <div
                  key={activity.id || activity._id}
                  className="activity-item"
                  style={{ borderLeftColor: getCategoryColor(activity.category) }}
                >
                  <div className="activity-item-header">
                    <div className="activity-item-time">{activity.time}</div>
                    <div className="activity-item-category">{activity.category}</div>
                  </div>
                  <div className="activity-item-title">{activity.title}</div>
                  <div className="activity-item-meta">
                    <span>ğŸ“… {formatDate(activity.date)}</span>
                    <span>ğŸ“ {activity.location}</span>
                    <span className="activity-item-price">{activity.price}</span>
                  </div>
                </div>
              ))}
              {filteredActivities.length === 0 && (
                <div className="no-results">
                  <p>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ´»åŠ¨</p>
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      {/* æ´»åŠ¨ç»Ÿè®¡ */}
      <div className="stats-bar">
        å…± <span className="highlight">{filteredActivities.length}</span> ä¸ªæ´»åŠ¨
      </div>
    </div>
  )
}

export default App
