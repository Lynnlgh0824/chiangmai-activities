# 飞书个人版 - 数据导出集成方案

> 📅 创建日期：2025-01-25
> 🎯 目标：飞书个人版多维表格 ↔ 项目数据
> 👤 适用：飞书个人版用户

---

## 🎯 方案对比

| 方案 | 实时性 | 复杂度 | 适用版本 | 推荐度 |
|------|--------|--------|----------|--------|
| **方案1：手动CSV导出** | ❌ 手动 | ⭐ | 个人/企业 | ⭐⭐⭐⭐⭐ |
| **方案2：飞书自动化(Pro)** | ⚡ 实时 | ⭐⭐ | 个人Pro | ⭐⭐⭐⭐ |
| **方案3：企业自建应用** | ⚡ 实时 | ⭐⭐⭐⭐ | 企业版 | ⭐⭐⭐⭐ |

### 推荐方案

**个人版用户**：使用方案1（手动CSV导出）
**个人Pro版**：使用方案2（飞书自动化）
**企业版**：使用方案3（API集成，已实现）

---

## 📋 方案1：手动CSV导出（推荐个人版）

### 工作流程

```
┌─────────────────┐
│ 飞书多维表格     │
└────────┬────────┘
         │ 编辑数据
         ↓
    手动导出CSV
         ↓
┌─────────────────┐
│ Python转换脚本   │
│ csv-to-json.py  │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│ items.json      │
│ (项目数据文件)   │
└─────────────────┘
```

### 实施步骤

#### 步骤1：在飞书多维表格中录入数据

1. 打开多维表格：https://my.feishu.cn/base/Tm8CbHiQUah6SSs5oL9cJ4qYnvd
2. 按照表格模板录入活动数据
3. 确保数据格式正确（参考"活动录入表格-使用说明.md"）

#### 步骤2：导出CSV文件

1. 在飞书多维表格中：
   - 点击右上角 "..." 菜单
   - 选择 "下载为" → "CSV"
   - 保存为 `活动数据.csv`

#### 步骤3：使用Python脚本转换数据

创建转换脚本 `csv-to-json.py`：

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
飞书多维表格CSV → 项目JSON转换工具
"""

import csv
import json
from datetime import datetime

def parse_weekdays(weekday_str):
    """解析星期字符串为数组"""
    weekday_map = {
        '周一': 1, '周二': 2, '周三': 3, '周四': 4,
        '周五': 5, '周六': 6, '周日': 0
    }

    if not weekday_str:
        return []

    return weekday_str.split(',') \
        .map(s => s.strip()) \
        .filter(s => weekday_map.get(s)) \
        .map(s => weekday_map[s])

def parse_images(url_str):
    """解析图片URL字符串"""
    if not url_str:
        return []

    return url_str.split(/[\n,]+/) \
        .map(s => s.strip()) \
        .filter(s => len(s) > 0)

def map_status(status):
    """映射状态字段"""
    status_map = {
        '草稿': 'draft',
        '待开始': 'upcoming',
        '进行中': 'ongoing',
        '已过期': 'expired'
    }
    return status_map.get(status, 'active')

def convert_csv_to_json(csv_file, json_file):
    """转换CSV到JSON格式"""

    items = []

    with open(csv_file, 'r', encoding='utf-8-sig') as f:
        reader = csv.DictReader(f)

        for row in reader:
            # 跳过空行
            if not row.get('活动标题'):
                continue

            # 判断活动类型
            activity_type = row.get('活动类型', '固定频率')

            item = {
                'id': row.get('序号') or str(datetime.now().timestamp()),
                '_id': row.get('序号') or str(datetime.now().timestamp()),
                'title': row.get('活动标题', ''),
                'category': row.get('分类', '其他'),
                'status': map_status(row.get('状态')),
                'description': row.get('活动描述', ''),
                'time': row.get('时间', ''),
                'duration': row.get('持续时间', ''),
                'location': row.get('地点名称', ''),
                'address': row.get('详细地址', ''),
                'price': row.get('价格显示', ''),
                'priceMin': int(row.get('最低价格') or 0),
                'priceMax': int(row.get('最高价格') or 0),
                'currency': '฿',
                'maxParticipants': int(row.get('最大人数') or 0),
                'flexibleTime': row.get('灵活时间') == '是',
                'bookingRequired': row.get('需要预约') == '是',
                'images': parse_images(row.get('图片URL')),
                'source': {
                    'name': '飞书表格录入',
                    'url': row.get('来源链接', ''),
                    'type': 'feishu',
                    'lastUpdated': datetime.now().isoformat()
                },
                'createdAt': datetime.now().isoformat(),
                'updatedAt': datetime.now().isoformat()
            }

            # 根据活动类型添加字段
            if activity_type == '固定频率':
                item['weekdays'] = parse_weekdays(row.get('星期/日期'))
                item['frequency'] = 'weekly'
            else:
                item['date'] = row.get('星期/日期')
                item['frequency'] = 'once'

            items.append(item)

    # 保存为JSON
    with open(json_file, 'w', encoding='utf-8') as f:
        json.dump(items, f, ensure_ascii=False, indent=2)

    print(f"✅ 转换完成: {len(items)} 条记录")
    print(f"📁 输出文件: {json_file}")

    return items

if __name__ == '__main__':
    import sys

    csv_file = sys.argv[1] if len(sys.argv) > 1 else '活动数据.csv'
    json_file = sys.argv[2] if len(sys.argv) > 2 else 'data/items.json'

    print("🔄 开始转换飞书CSV数据...")
    convert_csv_to_json(csv_file, json_file)
    print("✅ 完成！请刷新前端页面查看更新")
```

#### 步骤4：运行转换脚本

```bash
# 安装依赖（如需要）
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pandas

# 运行转换
python csv-to-json.py 活动数据.csv data/items.json

# 或者使用默认路径
python csv-to-json.py
```

#### 步骤5：验证数据

1. 检查 `data/items.json` 文件
2. 刷新前端页面：http://localhost:5173
3. 查看数据是否正确显示

---

## 🔧 方案2：飞书自动化（个人Pro版）

### 前提条件

- 飞书个人Pro版
- 支持自动化功能
- 可以创建webhook请求

### 设置步骤

#### 步骤1：获取公网服务器URL

由于本地开发环境没有公网IP，需要使用内网穿透工具：

**使用ngrok（推荐）**：

```bash
# 安装ngrok
brew install ngrok  # macOS

# 启动隧道
ngrok http 3000

# 会显示公网URL，例如：
# https://abc123.ngrok.io
```

#### 步骤2：在飞书多维表格中创建自动化

1. 打开多维表格
2. 点击右上角 "自动化" → "新建自动化"
3. 设置触发器：
   - 选择 "记录被更改时"
   - 选择数据表
4. 设置操作：
   - 添加 "发送请求"
   - 方法：`POST`
   - URL：`https://你的ngrok.io/api/sync-from-feishu`
   - Headers：
     ```json
     {
       "Content-Type": "application/json"
     }
     ```
5. 保存并启用

#### 步骤3：测试自动化

1. 在多维表格中编辑一条记录
2. 观察服务器日志是否收到webhook请求
3. 检查前端数据是否自动更新

---

## 📊 飞书表格字段说明

### 必需字段

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| 序号 | 文本 | 唯一标识 | 1, 2, 3 |
| 活动类型 | 单选 | 固定频率/临时活动 | 固定频率 |
| 活动标题 | 文本 | 活动名称 | 流瑜伽基础班 |
| 分类 | 单选 | 活动分类 | 瑜伽 |
| 活动描述 | 文本 | 详细说明 | 适合初学者 |
| 星期/日期 | 文本 | 周1,3,5 或 2025-02-01 | 周一,周三,周五 |
| 时间 | 文本 | 活动时间 | 09:00-10:30 |
| 地点名称 | 文本 | 地点 | 宁曼一号瑜伽馆 |

### 可选字段

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| 状态 | 单选 | 草稿/待开始/进行中/已过期 | 待开始 |
| 持续时间 | 文本 | 时长 | 1.5小时 |
| 详细地址 | 文本 | 地址 | 清迈宁曼路1号 |
| 价格显示 | 文本 | 展示价格 | 免费、500฿ |
| 最低价格 | 数字 | 数字价格 | 0 |
| 最高价格 | 数字 | 数字价格 | 500 |
| 最大人数 | 数字 | 人数限制 | 15 |
| 灵活时间 | 单选 | 是/否 | 否 |
| 需要预约 | 单选 | 是/否 | 是 |
| 图片URL | 文本 | 图片链接 | https://... |
| 来源链接 | URL | 链接 | https://... |

---

## 💡 使用建议

### 日常使用流程

1. **录入数据**：在飞书多维表格中添加/编辑活动
2. **导出CSV**：点击"下载为" → "CSV"
3. **运行转换**：执行 `python csv-to-json.py`
4. **验证数据**：刷新前端页面检查

### 批量更新

如果需要更新大量数据：

1. 在Excel中编辑数据
2. 复制粘贴到飞书多维表格
3. 导出CSV
4. 运行转换脚本

### 数据备份

建议定期备份数据：

```bash
# 备份items.json
cp data/items.json data/items-backup-$(date +%Y%m%d).json
```

---

## ⚠️ 常见问题

### Q1: CSV导出后中文乱码？

**A**: 确保使用 UTF-8 编码打开文件

```python
# 读取CSV时指定编码
with open(csv_file, 'r', encoding='utf-8-sig') as f:
    reader = csv.DictReader(f)
```

### Q2: 转换后数据不显示？

**A**: 检查以下几点：
1. items.json 格式是否正确
2. 服务器是否需要重启
3. 浏览器是否需要刷新（Ctrl+F5）

### Q3: 如何更新已有数据？

**A**:
1. 在飞书表格中修改数据
2. 重新导出CSV
3. 运行转换脚本（会覆盖原文件）

### Q4: 能保留手动添加的数据吗？

**A**: 可以修改转换脚本，先读取现有items.json，然后合并数据：

```python
def merge_data(existing_file, new_items):
    """合并新旧数据"""
    with open(existing_file, 'r', encoding='utf-8') as f:
        existing = json.load(f)

    # 创建ID映射
    item_map = {item['id']: item for item in existing}

    # 更新或新增
    for item in new_items:
        item_map[item['id']] = item

    return list(item_map.values())
```

---

## 🚀 快速开始（3步）

### 第一次使用

```bash
# 1. 从飞书导出CSV
# 在飞书多维表格中：下载 → CSV → 保存为 活动数据.csv

# 2. 运行转换脚本
python csv-to-json.py 活动数据.csv data/items.json

# 3. 刷新前端页面
# 访问 http://localhost:5173 查看更新
```

### 日常更新

```bash
# 1. 在飞书中编辑数据
# 2. 导出CSV（覆盖旧文件）
# 3. 运行：python csv-to-json.py
```

---

## 📞 技术支持

如有问题，请检查：

1. ✅ Python 版本 >= 3.7
2. ✅ CSV 文件编码为 UTF-8
3. ✅ CSV 列名与飞书表格字段名一致
4. ✅ items.json 文件路径正确

---

**最后更新**：2025-01-25
**适用版本**：飞书个人版
**推荐频率**：每次数据更新后手动同步
