# é£ä¹¦å¤šç»´è¡¨æ ¼ - è‡ªåŠ¨åŒæ­¥é›†æˆæŒ‡å—

> ğŸ“… åˆ›å»ºæ—¥æœŸï¼š2025-01-25
> ğŸ¯ ç›®æ ‡ï¼šé£ä¹¦è¡¨æ ¼ â†” é¡¹ç›®æ•°æ® è‡ªåŠ¨åŒæ­¥

---

## ğŸ¯ é›†æˆæ–¹æ¡ˆæ¦‚è§ˆ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®æ—¶æ€§ | å¤æ‚åº¦ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|--------|--------|------|------|--------|
| **Webhookè‡ªåŠ¨åŒæ­¥** | âš¡ å®æ—¶ | â­â­â­â­ | è‡ªåŠ¨è§¦å‘ï¼Œæ— éœ€è½®è¯¢ | éœ€è¦å…¬ç½‘æœåŠ¡å™¨ | â­â­â­â­â­ |
| **å®šæ—¶åŒæ­¥** | ğŸ•’ 5åˆ†é’Ÿ | â­â­ | å®ç°ç®€å• | æœ‰å»¶è¿Ÿ | â­â­â­â­ |
| **æ‰‹åŠ¨åŒæ­¥** | âŒ æ‰‹åŠ¨ | â­ | æœ€ç®€å• | éœ€è¦æ‰‹åŠ¨æ“ä½œ | â­â­â­ |

### æ¨èæ–¹æ¡ˆ

**æœ¬åœ°å¼€å‘é˜¶æ®µ**ï¼šä½¿ç”¨æ–¹æ¡ˆ3ï¼ˆæ‰‹åŠ¨åŒæ­¥ï¼‰
**ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨æ–¹æ¡ˆ1ï¼ˆWebhookè‡ªåŠ¨åŒæ­¥ï¼‰æˆ–æ–¹æ¡ˆ2ï¼ˆå®šæ—¶åŒæ­¥ï¼‰

---

## ğŸ”§ æ–¹æ¡ˆ1ï¼šWebhookè‡ªåŠ¨åŒæ­¥ï¼ˆæ¨èï¼‰

### æ¶æ„æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é£ä¹¦å¤šç»´è¡¨æ ¼  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ç”¨æˆ·ç¼–è¾‘æ•°æ®
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é£ä¹¦è‡ªåŠ¨åŒ–/HTTP  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Webhookè§¦å‘
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¡¹ç›®æœåŠ¡å™¨API     â”‚
â”‚  /api/sync-feishu  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ éªŒè¯ + å¤„ç†
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è°ƒç”¨é£ä¹¦API      â”‚
â”‚ è·å–æœ€æ–°æ•°æ®      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ›´æ–°items.json   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯è‡ªåŠ¨åˆ·æ–°æ˜¾ç¤º â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®æ–½æ­¥éª¤

#### æ­¥éª¤1ï¼šè·å–é£ä¹¦å‡­è¯

1. è®¿é—® [é£ä¹¦å¼€æ”¾å¹³å°](https://open.feishu.cn/)
2. ç™»å½• â†’ å¼€å‘è€…åå°
3. åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨
4. è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
   - **App ID**: `cli_xxxxxxxxx`
   - **App Secret**: `xxxxxxxxxxxxxxxx`
   - **Tenant Key**: `xxxxxxxxxxxxxxxx`

#### æ­¥éª¤2ï¼šé…ç½®å¤šç»´è¡¨æ ¼

1. æ‰“å¼€é£ä¹¦å¤šç»´è¡¨æ ¼
2. åˆ›å»ºæ–°è¡¨æ ¼ï¼ˆæˆ–ä½¿ç”¨ç°æœ‰çš„ï¼‰
3. è®°å½•è¡¨æ ¼ä¿¡æ¯ï¼š
   - **Spreadsheet Token**: `bascnxxxxxxxxxxxxxx`
   - **Sheet ID**: `xxxxxxxxx`

**è·å–æ–¹æ³•**ï¼š
- æ‰“å¼€è¡¨æ ¼ â†’ åˆ†äº« â†’ å¤åˆ¶é“¾æ¥
- ä»é“¾æ¥ä¸­æå–tokenå’Œsheet_id

#### æ­¥éª¤3ï¼šåˆ›å»ºè‡ªåŠ¨åŒ–ï¼ˆWebhookï¼‰

1. åœ¨é£ä¹¦å¤šç»´è¡¨æ ¼ä¸­ï¼š
   - ç‚¹å‡»å³ä¸Šè§’"è‡ªåŠ¨åŒ–"
   - ç‚¹å‡»"+ æ–°å»ºè‡ªåŠ¨åŒ–"
   - é€‰æ‹©"ç©ºç™½æµç¨‹"

2. è®¾ç½®è§¦å‘å™¨ï¼š
   - æ·»åŠ è§¦å‘å™¨ â†’ "è®°å½•è¢«æ›´æ”¹æ—¶"
   - é€‰æ‹©æ•°æ®è¡¨å’ŒèŒƒå›´

3. è®¾ç½®æ“ä½œï¼š
   - æ·»åŠ æ“ä½œ â†’ "å‘é€è¯·æ±‚"
   - æ–¹æ³•ï¼š`POST`
   - URLï¼š`https://ä½ çš„æœåŠ¡å™¨/api/sync-from-feishu`
   - Headersï¼š
     ```json
     {
       "Content-Type": "application/json"
     }
     ```
   - Bodyï¼šç•™ç©ºæˆ–æ·»åŠ éªŒè¯ä¿¡æ¯

4. ä¿å­˜å¹¶å¯ç”¨è‡ªåŠ¨åŒ–

#### æ­¥éª¤4ï¼šé…ç½®æœåŠ¡å™¨ç¯å¢ƒå˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# é£ä¹¦é…ç½®
FEISHU_APP_ID=cli_xxxxxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxxxxxxxx
FEISHU_SPREADSHEET_TOKEN=bascnxxxxxxxxxxxxxx
FEISHU_SHEET_ID=xxxxxxxxx
```

#### æ­¥éª¤5ï¼šé›†æˆåˆ°é¡¹ç›®

å°† `feishu-integration.js` çš„ä»£ç é›†æˆåˆ° `server.js`ï¼š

```javascript
// 1. å®‰è£…ä¾èµ–
npm install axios

// 2. åœ¨ server.js å¼€å¤´æ·»åŠ 
require('dotenv').config();

// 3. å¤åˆ¶feishu-integration.jsçš„ä»£ç åˆ°server.js

// 4. å¯åŠ¨æœåŠ¡å™¨
npm start
```

---

## ğŸ”§ æ–¹æ¡ˆ2ï¼šå®šæ—¶åŒæ­¥ï¼ˆç®€åŒ–ç‰ˆï¼‰

### é€‚åˆåœºæ™¯

- æœ¬åœ°å¼€å‘ç¯å¢ƒ
- æ²¡æœ‰å…¬ç½‘æœåŠ¡å™¨
- ä¸éœ€è¦å®æ—¶åŒæ­¥

### å®æ–½æ­¥éª¤

1. **é…ç½®ç¯å¢ƒå˜é‡**ï¼ˆåŒæ–¹æ¡ˆ1æ­¥éª¤4ï¼‰

2. **æ·»åŠ å®šæ—¶åŒæ­¥ä»£ç **åˆ° server.jsï¼š

```javascript
// å®šæ—¶åŒæ­¥ï¼ˆæ¯5åˆ†é’Ÿï¼‰
setInterval(async () => {
  console.log('ğŸ”„ å¼€å§‹ä»é£ä¹¦åŒæ­¥æ•°æ®...');
  try {
    const feishuData = await fetchFeishuData();
    await updateLocalData(feishuData);
    console.log('âœ… åŒæ­¥å®Œæˆ');
  } catch (error) {
    console.error('âŒ åŒæ­¥å¤±è´¥:', error);
  }
}, 5 * 60 * 1000); // 5åˆ†é’Ÿ
```

3. **å¯åŠ¨æœåŠ¡å™¨**

```bash
npm start
```

---

## ğŸ”§ æ–¹æ¡ˆ3ï¼šæ‰‹åŠ¨åŒæ­¥æŒ‰é’®

### é€‚åˆåœºæ™¯

- æµ‹è¯•é˜¶æ®µ
- å¶å°”éœ€è¦åŒæ­¥
- æœ€ç®€å•å¿«é€Ÿ

### å®æ–½æ­¥éª¤

1. **æ·»åŠ æ‰‹åŠ¨åŒæ­¥æ¥å£**ï¼ˆå·²åœ¨ feishu-integration.js ä¸­ï¼‰

2. **åœ¨ç®¡ç†åå°æ·»åŠ åŒæ­¥æŒ‰é’®**

åœ¨ `admin.html` ä¸­æ·»åŠ ï¼š

```html
<button class="btn btn-info" onclick="manualSync()">
  ğŸ”„ ä»é£ä¹¦åŒæ­¥æ•°æ®
</button>

<script>
async function manualSync() {
  const button = event.target;
  button.disabled = true;
  button.textContent = 'â³ åŒæ­¥ä¸­...';

  try {
    const response = await fetch('/api/sync-manual', {
      method: 'POST'
    });

    const result = await response.json();

    if (result.success) {
      alert('âœ… ' + result.message);
      location.reload(); // åˆ·æ–°é¡µé¢
    } else {
      alert('âŒ ' + result.message);
    }
  } catch (error) {
    alert('âŒ åŒæ­¥å¤±è´¥: ' + error.message);
  } finally {
    button.disabled = false;
    button.textContent = 'ğŸ”„ ä»é£ä¹¦åŒæ­¥æ•°æ®';
  }
}
</script>
```

3. **ä½¿ç”¨æ–¹å¼**ï¼š
   - æ‰“å¼€ç®¡ç†åå°
   - ç‚¹å‡»"ä»é£ä¹¦åŒæ­¥æ•°æ®"æŒ‰é’®
   - ç­‰å¾…åŒæ­¥å®Œæˆ
   - é¡µé¢è‡ªåŠ¨åˆ·æ–°

---

## ğŸ“‹ é£ä¹¦è¡¨æ ¼æ¨¡æ¿

### å¿…éœ€åˆ—ï¼ˆä¸Excelè¡¨æ ¼å¯¹åº”ï¼‰

| åˆ—å | æ•°æ®ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|---------|------|------|
| åºå· | æ–‡æœ¬ | âŒ | è‡ªåŠ¨ç¼–å· |
| æ´»åŠ¨ç±»å‹ | å•é€‰ | âœ… | å›ºå®šé¢‘ç‡/ä¸´æ—¶æ´»åŠ¨ |
| æ´»åŠ¨æ ‡é¢˜ | æ–‡æœ¬ | âœ… | æ´»åŠ¨åç§° |
| åˆ†ç±» | å•é€‰ | âœ… | ä¸‹æ‹‰é€‰æ‹© |
| çŠ¶æ€ | å•é€‰ | âŒ | ä¸‹æ‹‰é€‰æ‹© |
| æ´»åŠ¨æè¿° | æ–‡æœ¬ | âœ… | è¯¦ç»†è¯´æ˜ |
| æ˜ŸæœŸ/æ—¥æœŸ | æ–‡æœ¬ | âœ… | å›ºå®šé¢‘ç‡å¡«"å‘¨ä¸€,å‘¨ä¸‰,å‘¨äº”"ï¼Œä¸´æ—¶å¡«"2025-02-01" |
| æ—¶é—´ | æ–‡æœ¬ | âœ… | 09:00-10:30 |
| æŒç»­æ—¶é—´ | æ–‡æœ¬ | âŒ | 1.5å°æ—¶ |
| åœ°ç‚¹åç§° | æ–‡æœ¬ | âœ… | åœ°ç‚¹ |
| è¯¦ç»†åœ°å€ | æ–‡æœ¬ | âŒ | åœ°å€ |
| ä»·æ ¼æ˜¾ç¤º | æ–‡æœ¬ | âŒ | å…è´¹ã€500à¸¿ |
| æœ€ä½ä»·æ ¼ | æ•°å­— | âŒ | 0 |
| æœ€é«˜ä»·æ ¼ | æ•°å­— | âŒ | 0 |
| æœ€å¤§äººæ•° | æ•°å­— | âŒ | 15 |
| çµæ´»æ—¶é—´ | å•é€‰ | âŒ | æ˜¯/å¦ |
| éœ€è¦é¢„çº¦ | å•é€‰ | âŒ | æ˜¯/å¦ |
| å›¾ç‰‡URL | æ–‡æœ¬ | âŒ | æ¯è¡Œä¸€ä¸ª |
| æ¥æºé“¾æ¥ | URL | âŒ | https://... |

### è®¾ç½®ä¸‹æ‹‰é€‰é¡¹

**æ´»åŠ¨ç±»å‹åˆ—**ï¼š
- å›ºå®šé¢‘ç‡
- ä¸´æ—¶æ´»åŠ¨

**åˆ†ç±»åˆ—**ï¼š
- ç‘œä¼½
- å†¥æƒ³
- æˆ·å¤–æ¢é™©
- æ–‡åŒ–è‰ºæœ¯
- ç¾é£Ÿä½“éªŒ
- èŠ‚åº†æ´»åŠ¨
- å…¶ä»–

**çŠ¶æ€åˆ—**ï¼š
- è‰ç¨¿
- å¾…å¼€å§‹
- è¿›è¡Œä¸­
- å·²è¿‡æœŸ

**çµæ´»æ—¶é—´/éœ€è¦é¢„çº¦åˆ—**ï¼š
- æ˜¯
- å¦

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. APIé™åˆ¶

é£ä¹¦å…è´¹ç‰ˆAPIé™åˆ¶ï¼š
- æ¯åˆ†é’Ÿæœ€å¤š100æ¬¡è¯·æ±‚
- æ¯æœˆæœ€å¤š100,000æ¬¡è¯·æ±‚

å»ºè®®ï¼š
- ä½¿ç”¨Webhookæ—¶æ·»åŠ é˜²æŠ–ï¼ˆdebounceï¼‰
- é¿å…çŸ­æ—¶é—´å†…å¤šæ¬¡ç¼–è¾‘
- è®¾ç½®æœ€å°åŒæ­¥é—´éš”ï¼ˆå¦‚30ç§’ï¼‰

### 2. æ•°æ®å®‰å…¨

- éªŒè¯webhookç­¾å
- ä½¿ç”¨HTTPS
- å®šæœŸå¤‡ä»½items.json
- è®°å½•åŒæ­¥æ—¥å¿—

### 3. å†²çªå¤„ç†

- ä»¥é£ä¹¦è¡¨æ ¼æ•°æ®ä¸ºå‡†
- æˆ–å®ç°åŒå‘åŒæ­¥ï¼ˆè¾ƒå¤æ‚ï¼‰
- å»ºè®®å•å‘åŒæ­¥ï¼šé£ä¹¦ â†’ é¡¹ç›®

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ3åˆ†é’Ÿï¼‰

### æœ¬åœ°æµ‹è¯• - æ‰‹åŠ¨åŒæ­¥ç‰ˆ

```bash
# 1. å®‰è£…ä¾èµ–
npm install axios dotenv

# 2. åˆ›å»º.envæ–‡ä»¶
cat > .env << EOF
FEISHU_APP_ID=ä½ çš„App_ID
FEISHU_APP_SECRET=ä½ çš„App_Secret
FEISHU_SPREADSHEET_TOKEN=ä½ çš„Token
FEISHU_SHEET_ID=ä½ çš„Sheet_ID
EOF

# 3. é›†æˆä»£ç ï¼ˆå¤åˆ¶feishu-integration.jsåˆ°server.jsï¼‰

# 4. å¯åŠ¨æœåŠ¡å™¨
npm start

# 5. æµ‹è¯•åŒæ­¥
curl -X POST http://localhost:3000/api/sync-manual
```

### ç”Ÿäº§ç¯å¢ƒ - Webhookè‡ªåŠ¨åŒæ­¥

1. éƒ¨ç½²æœåŠ¡å™¨åˆ°å…¬ç½‘ï¼ˆRailway/Vercelç­‰ï¼‰
2. é…ç½®ç¯å¢ƒå˜é‡
3. åœ¨é£ä¹¦å¤šç»´è¡¨æ ¼ä¸­è®¾ç½®Webhookï¼š
   - URL: `https://ä½ çš„æœåŠ¡å™¨/api/sync-from-feishu`
4. æµ‹è¯•ç¼–è¾‘é£ä¹¦è¡¨æ ¼ï¼Œè§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨åŒæ­¥

---

## ğŸ“Š æ•°æ®æµç¤ºä¾‹

### é£ä¹¦è¡¨æ ¼ â†’ é¡¹ç›®æ•°æ®åº“

**é£ä¹¦è¡¨æ ¼æ•°æ®**ï¼š
```json
{
  "åºå·": "1",
  "æ´»åŠ¨ç±»å‹": "å›ºå®šé¢‘ç‡",
  "æ´»åŠ¨æ ‡é¢˜": "æµç‘œä¼½åŸºç¡€ç­",
  "åˆ†ç±»": "ç‘œä¼½",
  "æ˜ŸæœŸ/æ—¥æœŸ": "å‘¨ä¸€,å‘¨ä¸‰,å‘¨äº”",
  "æ—¶é—´": "09:00-10:30",
  ...
}
```

**è½¬æ¢åçš„é¡¹ç›®æ•°æ®**ï¼š
```json
{
  "id": "xxx",
  "title": "æµç‘œä¼½åŸºç¡€ç­",
  "category": "ç‘œä¼½",
  "weekdays": [1, 3, 5],
  "time": "09:00-10:30",
  "frequency": "weekly",
  "source": {
    "name": "é£ä¹¦è¡¨æ ¼å½•å…¥",
    "type": "feishu",
    "lastUpdated": "2025-01-25T12:00:00.000Z"
  }
}
```

---

## ğŸ é¢å¤–åŠŸèƒ½å»ºè®®

### 1. åŒæ­¥å†å²è®°å½•

```javascript
// è®°å½•æ¯æ¬¡åŒæ­¥
const syncLog = {
  timestamp: new Date().toISOString(),
  recordCount: feishuData.length,
  status: 'success'
};

fs.appendFileSync('sync-log.json', JSON.stringify(syncLog) + '\n');
```

### 2. å¢é‡åŒæ­¥

```javascript
// åªåŒæ­¥æœ€è¿‘ä¿®æ”¹çš„è®°å½•
const lastSyncTime = getLastSyncTime();
const newRecords = feishuData.filter(item => {
  return new Date(item.modified_time) > lastSyncTime;
});
```

### 3. å†²çªè§£å†³ç­–ç•¥

```javascript
// ç­–ç•¥1: é£ä¹¦ä¼˜å…ˆï¼ˆæ¨èï¼‰
// ç­–ç•¥2: æœ¬åœ°ä¼˜å…ˆ
// ç­–ç•¥3: è¯¢é—®ç”¨æˆ·
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### é£ä¹¦APIæ–‡æ¡£
- å¼€æ”¾å¹³å°ï¼šhttps://open.feishu.cn/
- APIæ–‡æ¡£ï¼šhttps://open.feishu.cn/document/server-docs/

### å¸¸è§é—®é¢˜

**Q1: Webhookä¸è§¦å‘ï¼Ÿ**
- æ£€æŸ¥æœåŠ¡å™¨URLæ˜¯å¦å¯è®¿é—®
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æŸ¥çœ‹é£ä¹¦è‡ªåŠ¨åŒ–æ—¥å¿—

**Q2: APIè°ƒç”¨å¤±è´¥ï¼Ÿ**
- æ£€æŸ¥å‡­è¯æ˜¯å¦æ­£ç¡®
- ç¡®è®¤åº”ç”¨æƒé™å·²æˆäºˆ
- æŸ¥çœ‹tokenæ˜¯å¦è¿‡æœŸ

**Q3: æ•°æ®æ ¼å¼ä¸å¯¹ï¼Ÿ**
- æ£€æŸ¥åˆ—åæ˜¯å¦åŒ¹é…
- æŸ¥çœ‹æ•°æ®è½¬æ¢é€»è¾‘
- æ·»åŠ è°ƒè¯•æ—¥å¿—

---

**éœ€è¦å¸®åŠ©å®ç°å—ï¼Ÿæˆ‘å¯ä»¥å¸®ä½ ï¼š**
1. é…ç½®é£ä¹¦åº”ç”¨å’Œè·å–APIå‡­è¯
2. ç¼–å†™å®Œæ•´çš„åŒæ­¥ä»£ç 
3. è°ƒè¯•å’Œä¼˜åŒ–åŒæ­¥é€»è¾‘
4. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

é€‰æ‹©ä¸€ä¸ªæ–¹æ¡ˆï¼Œè®©æˆ‘å¸®ä½ å®ç°ï¼ğŸ˜Š
